# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

Project: Pi Player (Raspberry Pi media player)

- Language/tooling: Python 3 with FastAPI, uvicorn, requests, psutil; external players (mpv/vlc/feh)
- Dev mode: When PI_PLAYER_DEV=true, Config.BASE_DIR remaps to ./connect for cache/logs/state
- Primary entry points: main.py (orchestrates downloads + playback), pi_server.py (FastAPI API server)

Common commands (Linux, bash)

- Install runtime dependencies (from README)
```bash path=null start=null
sudo apt update && sudo apt upgrade -y
sudo apt install -y python3 python3-pip vlc ffmpeg feh curl wget git
pip3 install --user "fastapi[standard]" "uvicorn[standard]" psutil requests
```

- Run the API server in development (auto-sets PI_PLAYER_DEV=true and enables reload)
```bash path=null start=null
python3 pi_server.py
# Alternatively (sets PI_PLAYER_DEV yourself):
export PI_PLAYER_DEV=true
python3 -m uvicorn pi_server:app --host 0.0.0.0 --port 8000 --reload --log-level info
```

- Run the full system (initialize, download/sync, then play)
```bash path=null start=null
python3 main.py
```

- Run only player (assumes media already in cache)
```bash path=null start=null
python3 main.py --player-only
```

- Sync playlist downloads without starting playback
```bash path=null start=null
python3 main.py --download
# or use the download manager directly
python3 download_manager.py --download
```

- Reset cache, then trigger a fresh download
```bash path=null start=null
python3 main.py --reset-cache
```

- Show system/cache status
```bash path=null start=null
python3 main.py --status
python3 download_manager.py --status
```

- Run tests
```bash path=null start=null
# Runs the system-level test suite (imports, telemetry, downloader, API endpoints, player logic)
python3 test_system.py
```

- Run a single test script
```bash path=null start=null
python3 test_playlist_simple.py
python3 test_playlist_integration.py
```

- Service management (installed services; see README for details)
```bash path=null start=null
sudo systemctl status pi-player.service
sudo systemctl status media-player.service
sudo systemctl restart pi-player.service
sudo systemctl restart media-player.service
journalctl -u pi-player.service -u media-player.service --no-pager -n 200
```

Lint/format

- No linter/formatter configuration is present in the repo.

High-level architecture and data flow

- Configuration (config.py)
  - Centralizes paths, logging, download, and backend settings.
  - In dev mode (PI_PLAYER_DEV=true), BASE_DIR is remapped to ./connect and required subdirs are created: media_cache, logs, services, playlists. Key files: current_playlist.json, playback_state.json.

- API server (pi_server.py)
  - FastAPI app exposing endpoints: /
    - /health: health check
    - /telemetry: returns telemetry plus server/config and backend status
    - /playlist (GET/POST): manage current playlist; saving triggers background download; uses PlaylistManager to ensure a fallback playlist exists when needed
    - /control/{action}: play/pause/stop/next/restart signals via playback_state.json
    - Backend helpers: /backend/heartbeat, /backend/telemetry, /backend/status; Playlist manager endpoints: /playlist/manager/status, /playlist/manager/refresh, /playlist/load-default
  - Startup registers background backend integration (heartbeat, telemetry, playlist fetch) and ensures an initial playlist (backend or fallback).
  - Note: The server references media_downloader.update_cache_for_playlist; in this codebase, the download component is in download_manager.py (load_and_download_playlist, download_playlist_items). When extending server-side download logic, use download_manager APIs.

- Playlist management (playlist_manager.py)
  - Ensures a playlist is present by attempting to fetch from backend; if unavailable after a delay, writes a default playlist to current_playlist.json. Two defaults:
    - Cloudinary collection placeholder playlist (7 collections)
    - Sample video playlist (Big Buck Bunny, etc.)
  - Exposes status (backend enabled/available, current source, etc.) and can be forced to refresh from backend.

- Download/cache manager (download_manager.py)
  - Loads playlist JSON and downloads unique items concurrently with retries; verifies checksums when provided; maintains a progress tracker; writes to media_cache.
  - Exposes: load_and_download_playlist, download_playlist_items, get_cache_status, and CLI flags (--status, --download).

- Media playback
  - player.py: Enhanced media player used by main.py. Detects available players (mpv/vlc/feh), chooses best, plays cached media, can show an autogenerated default screen when idle, writes playback_state.json with detailed state and periodic system stats. Handles looping, time-based image display, and default asset fallbacks/optimized variants.
  - media_player.py: Simpler daemon-style player variant with feh/cvlc command generation; used by systemd service in some deployments.

- Backend integration (backend_client.py)
  - Periodic heartbeat and telemetry to BACKEND_BASE_URL (config), plus periodic playlist fetch. On new playlist version, POSTs to local API /playlist for saving and download.
  - Uses threads for heartbeat, telemetry, and playlist workers; tracks last heartbeat/telemetry and recent errors.

- Orchestrator (main.py)
  - CLI modes: full system (init + download + playback), download-only, player-only, reset cache, status, init directories.
  - Initializes directories, copies a default playlist if none exists, runs an initial download sync, then invokes MediaPlayer().run_playback_loop().

- Boot and services
  - run.sh provides a comprehensive boot/startup sequence with health checks and status reporting.
  - services/ contains systemd unit files (pi-player.service, media-player.service, pi-player-startup.service). Deployment scripts under deployment/.

Development notes pulled from README

- API defaults to 0.0.0.0:8000 in dev; sample curl usage is in README for /playlist, /telemetry, /health.
- Logs are written under logs/: pi_server.log, download_manager.log, media_player.log, telemetry.log.
- Default assets live under default_assets/; generated default_screen.png is used when idle.

Conventions and quirks to remember in this repo

- Dev path remap: With PI_PLAYER_DEV=true (or when running python3 pi_server.py), data files and caches live under ./connect rather than the repository root; adjust paths when inspecting files.
- Prefer the enhanced player (player.py via main.py) during local development; systemd uses media_player.py in certain deployments.
- The FastAPI serverâ€™s downloader reference appears to be named for an earlier module (media_downloader). Use download_manager.py functions for cache updates when modifying server code.
