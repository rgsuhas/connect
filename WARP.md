# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

Project: Pi Player (Raspberry Pi media player)

- Language/tooling: Python 3 with FastAPI, uvicorn, requests, psutil; external players (mpv/vlc/feh)
- Dev mode: When PI_PLAYER_DEV=true, Config.BASE_DIR remaps to ./connect for cache/logs/state
- Primary entry points: main.py (orchestrates downloads + playback), pi_server.py (FastAPI API server)

Common commands (Linux, bash)

- Install runtime dependencies (from README)
```bash path=null start=null
sudo apt update && sudo apt upgrade -y
sudo apt install -y python3 python3-pip vlc ffmpeg feh curl wget git
pip3 install --user "fastapi[standard]" "uvicorn[standard]" psutil requests
```

- Run the API server in development (auto-sets PI_PLAYER_DEV=true and enables reload)
```bash path=null start=null
python3 pi_server.py
# Alternatively (sets PI_PLAYER_DEV yourself):
export PI_PLAYER_DEV=true
python3 -m uvicorn pi_server:app --host 0.0.0.0 --port 8000 --reload --log-level info
```

- Run the full system (initialize, download/sync, then play)
```bash path=null start=null
python3 main.py
```

- Run only player (assumes media already in cache)
```bash path=null start=null
python3 main.py --player-only
```

- Sync playlist downloads without starting playback
```bash path=null start=null
python3 main.py --download
# or use the download manager directly
python3 download_manager.py --download
```

- Reset cache, then trigger a fresh download
```bash path=null start=null
python3 main.py --reset-cache
```

- Show system/cache status
```bash path=null start=null
python3 main.py --status
python3 download_manager.py --status
```

- Run tests
```bash path=null start=null
# Runs the system-level test suite (imports, telemetry, downloader, API endpoints, player logic)
python3 test_system.py
```

- Run a single test script
```bash path=null start=null
python3 test_playlist_simple.py
python3 test_playlist_integration.py
```

- Service management (installed services; see README for details)
```bash path=null start=null
sudo systemctl status pi-player.service
sudo systemctl status media-player.service
sudo systemctl restart pi-player.service
sudo systemctl restart media-player.service
journalctl -u pi-player.service -u media-player.service --no-pager -n 200
```

Lint/format

- No linter/formatter configuration is present in the repo.

High-level architecture and data flow

- Configuration (config.py)
  - Centralizes paths, logging, download, and backend settings.
  - In dev mode (PI_PLAYER_DEV=true), BASE_DIR is remapped to ./connect and required subdirs are created: media_cache, logs, services, playlists. Key files: current_playlist.json, playback_state.json.

- API server (pi_server.py)
  - FastAPI app exposing endpoints: /
    - /health: health check
    - /telemetry: returns telemetry plus server/config and backend status
    - /playlist (GET/POST): manage current playlist; saving triggers background download; uses PlaylistManager to ensure a fallback playlist exists when needed
    - /control/{action}: play/pause/stop/next/restart signals via playback_state.json
    - Backend helpers: /backend/heartbeat, /backend/telemetry, /backend/status; Playlist manager endpoints: /playlist/manager/status, /playlist/manager/refresh, /playlist/load-default
  - Startup registers background backend integration (heartbeat, telemetry, playlist fetch) and ensures an initial playlist (backend or fallback).
  - Note: The server references media_downloader.update_cache_for_playlist; in this codebase, the download component is in download_manager.py (load_and_download_playlist, download_playlist_items). When extending server-side download logic, use download_manager APIs.

- Playlist management (playlist_manager.py)
  - Ensures a playlist is present by attempting to fetch from backend; if unavailable after a delay, writes a default playlist to current_playlist.json. Two defaults:
    - Cloudinary collection placeholder playlist (7 collections)
    - Sample video playlist (Big Buck Bunny, etc.)
  - Exposes status (backend enabled/available, current source, etc.) and can be forced to refresh from backend.

- Download/cache manager (download_manager.py)
  - Loads playlist JSON and downloads unique items concurrently with retries; verifies checksums when provided; maintains a progress tracker; writes to media_cache.
  - Exposes: load_and_download_playlist, download_playlist_items, get_cache_status, and CLI flags (--status, --download).

- Media playback
  - player.py: Enhanced media player used by main.py. Detects available players (mpv/vlc/feh), chooses best, plays cached media, can show an autogenerated default screen when idle, writes playback_state.json with detailed state and periodic system stats. Handles looping, time-based image display, and default asset fallbacks/optimized variants.
  - media_player.py: Simpler daemon-style player variant with feh/cvlc command generation; used by systemd service in some deployments.

- Backend integration (backend_client.py)
  - Periodic heartbeat and telemetry to BACKEND_BASE_URL (config), plus periodic playlist fetch. On new playlist version, POSTs to local API /playlist for saving and download.
  - Uses threads for heartbeat, telemetry, and playlist workers; tracks last heartbeat/telemetry and recent errors.

- Orchestrator (main.py)
  - CLI modes: full system (init + download + playback), download-only, player-only, reset cache, status, init directories.
  - Initializes directories, copies a default playlist if none exists, runs an initial download sync, then invokes MediaPlayer().run_playback_loop().

- Boot and services
  - run.sh provides a comprehensive boot/startup sequence with health checks and status reporting.
  - services/ contains systemd unit files (pi-player.service, media-player.service, pi-player-startup.service). Deployment scripts under deployment/.

Development notes pulled from README

- API defaults to 0.0.0.0:8000 in dev; sample curl usage is in README for /playlist, /telemetry, /health.
- Logs are written under logs/: pi_server.log, download_manager.log, media_player.log, telemetry.log.
- Default assets live under default_assets/; generated default_screen.png is used when idle.

Conventions and quirks to remember in this repo

- Dev path remap: With PI_PLAYER_DEV=true (or when running python3 pi_server.py), data files and caches live under ./connect rather than the repository root; adjust paths when inspecting files.
- Prefer the enhanced player (player.py via main.py) during local development; systemd uses media_player.py in certain deployments.
- The FastAPI server’s downloader reference appears to be named for an earlier module (media_downloader). Use download_manager.py functions for cache updates when modifying server code.

# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Overview

Pi Player is a Raspberry Pi media player system designed for digital signage and kiosk applications. It provides remote playlist management via REST API with automatic media downloading, caching, and fullscreen playback.

The system is architected around three main components:
1. **REST API Server** (`pi_server.py`) - FastAPI-based playlist management
2. **Media Player Daemon** (`player.py`/`media_player.py`) - Handles playback via VLC/MPV/feh
3. **Backend Integration** (`backend_client.py`) - Cloudinary and external API integration

## Quick Commands

### Installation
```bash
# Full installation with systemd services
./install.sh

# Headless installation (no GUI dependencies)  
./install_headless.sh

# Install only systemd services
./install_service.sh
```

### Development Mode
```bash
# Enable development mode (uses current directory instead of /home/pi/pi-player)
export PI_PLAYER_DEV=true

# Run main application
python3 main.py

# Run specific components
python3 pi_server.py          # API server only
python3 main.py --player-only # Media player only
python3 main.py --download    # Download playlist and exit
```

### Testing
```bash
# Run comprehensive test suite
python3 test_system.py

# Run specific tests
python3 test_playlist_integration.py
python3 test_playlist_simple.py
```

### Service Management
```bash
# Control main API service
sudo systemctl start pi-player.service
sudo systemctl stop pi-player.service
sudo systemctl restart pi-player.service
sudo systemctl status pi-player.service

# Control media player service
sudo systemctl start media-player.service
sudo systemctl stop media-player.service
sudo systemctl status media-player.service

# View logs
sudo journalctl -u pi-player.service -f
sudo journalctl -u media-player.service -f
```

### Cache Management
```bash
# Reset/clear media cache
python3 main.py --reset-cache

# Clean old cached files
python3 cleanup_old_cache.py

# Check cache status
python3 main.py --status
```

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   REST API      │    │  Media Player   │    │ Backend Client  │
│  (pi_server.py) │◄──►│   (player.py)   │    │(backend_client) │
│                 │    │                 │    │                 │
│ • Playlist CRUD │    │ • VLC/MPV/feh   │    │ • Cloudinary    │
│ • Telemetry     │    │ • Format detect │    │ • Heartbeat     │
│ • Health check  │    │ • Loop control  │    │ • Playlist sync │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │ Download Manager│
                    │(download_mgr.py)│
                    │                 │
                    │ • SHA256 verify │
                    │ • Cache mgmt    │
                    │ • Parallel DL   │
                    └─────────────────┘
```

### Key Subsystems

1. **Configuration** (`config.py`)
   - Centralized dataclass-based configuration
   - Auto-creates directories on initialization
   - Environment-aware (development vs production)

2. **Media Player** (`player.py`, `media_player.py`)
   - Supports video (MP4, AVI, MKV), audio (MP3, WAV), images (JPG, PNG)
   - Primary: VLC (cvlc), Secondary: MPV, Images: feh
   - Fullscreen kiosk mode with cursor hiding

3. **Download Manager** (`download_manager.py`)
   - SHA256 checksum verification
   - Incremental cache updates
   - Concurrent downloading with configurable limits

4. **Telemetry** (`telemetry.py`)
   - System stats (CPU, memory, disk, temperature)
   - Process monitoring
   - Playback state tracking

5. **Logging** (`log_setup.py`, `logger_setup.py`)
   - Structured logging with rotation
   - Component-specific log files in `logs/` directory
   - Console + file output support

## Development Patterns

### Configuration Pattern
All components use the centralized config:
```python
from config import config

# Access paths
config.MEDIA_CACHE_DIR
config.PLAYLIST_FILE
config.API_PORT

# File type detection
if config.is_video_file(filename):
    # Handle video
```

### Logging Pattern
Consistent logging setup across components:
```python
from log_setup import setup_logging

logger = setup_logging("component_name", log_level="INFO")
logger.info("Component started")
```

### Service Pattern
Background tasks use threading for non-blocking operations:
```python
import threading
from download_manager import update_cache_for_playlist

def background_download_task(playlist_data):
    # Download in background thread
    threading.Thread(target=update_cache_for_playlist).start()
```

### State Management
Playback state is persisted to JSON files:
- `current_playlist.json` - Active playlist
- `playback_state.json` - Current playback status
- `last_playback.json` - Last played item

## File Structure

```
pi-player/
├── config.py              # Central configuration
├── main.py                 # Main entry point
├── pi_server.py           # FastAPI REST server
├── player.py              # Main media player
├── media_player.py        # Player implementation
├── download_manager.py    # Media download & cache
├── backend_client.py      # External API client
├── telemetry.py          # System monitoring
├── playlist_manager.py   # Playlist operations
├── log_setup.py          # Logging utilities
├── services/             # Systemd service files
│   ├── pi-player.service
│   ├── media-player.service
│   └── pi-player-startup.service
├── logs/                 # Application logs
├── media_cache/          # Downloaded media files
├── playlists/           # Playlist storage
├── default_assets/      # Default screens
└── deployment/          # Deployment scripts
```

## Environment Configuration

The system supports both production and development environments:

**Production** (default):
- Base directory: `/home/pi/pi-player/`
- Systemd services enabled
- Runs as `pi` user

**Development**:
```bash
export PI_PLAYER_DEV=true
# Uses current working directory
# Logs to console + files
# No systemd dependency
```

## Common Tasks

### Adding New Media Format
1. Update `config.py` file type detection methods
2. Add player command in `media_player.py` or `player.py`
3. Test with sample files

### Modifying API Endpoints
1. Edit `pi_server.py` FastAPI routes
2. Update playlist schema validation
3. Test with `python3 test_system.py`

### Changing Backend Integration
1. Modify `backend_client.py` client implementation
2. Update `config.py` backend settings
3. Test with `python3 fetch_backend_playlist.py`

## Troubleshooting

### Common Issues

**Media not playing:**
```bash
# Check display environment
echo $DISPLAY
export DISPLAY=:0

# Check service status
sudo systemctl status media-player.service
```

**API not responding:**
```bash
# Check service and port
sudo systemctl status pi-player.service
netstat -tlnp | grep :8000
```

**Download failures:**
```bash
# Check network and logs
tail -f logs/downloader.log
curl -I https://example.com/test-media.mp4
```

**Permission errors:**
```bash
# Fix ownership
sudo chown -R pi:pi /home/pi/pi-player
chmod +x *.py
```

### Debug Mode
Enable verbose logging:
```python
# In config.py
LOG_LEVEL = "DEBUG"
```

### Service Logs
```bash
# View all pi-player logs
sudo journalctl -u pi-player.service -u media-player.service -f

# View specific component logs  
tail -f logs/pi_server.log
tail -f logs/media_player.log
tail -f logs/telemetry.log
```

## API Usage

### Base URL
`http://localhost:8000` (or Pi's IP address)

### Key Endpoints
- `GET /health` - Health check
- `GET /telemetry` - System telemetry
- `GET /playlist` - Get current playlist
- `POST /playlist` - Update playlist
- `POST /control/{action}` - Control playback

### Playlist Format
```json
{
    "version": "1.0",
    "last_updated": "2024-01-01T12:00:00Z",
    "loop": true,
    "items": [
        {
            "filename": "video1.mp4",
            "url": "https://example.com/video1.mp4",
            "checksum": "sha256hash",
            "duration": 30
        }
    ]
}
```

